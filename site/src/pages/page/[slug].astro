---
import Base from '../../layouts/Base.astro';
import { loadPublishedContent } from '../../lib/state';
import type { ProjectedPage } from '../../lib/state';
import { renderBlock } from '../../lib/blocks';
import type { Block, PageLike } from '../../lib/blocks';

export async function getStaticPaths() {
  const items = loadPublishedContent('page') as ProjectedPage[];
  // Skip page:home — it renders at / via index.astro
  return items
    .filter((p) => p.content_id !== 'page:home')
    .map((p) => ({
      params: { slug: p.meta.slug },
      props: { page: p },
    }));
}

const { page } = Astro.props as { page: ProjectedPage };
const base = import.meta.env.BASE_URL.replace(/\/$/, '');
const blockMap = new Map(page.blocks.map((b: Block) => [b.block_id, b]));
const pageLike: PageLike = page;
---
<Base
  title={page.meta.title}
  breadcrumbs={[
    { label: page.meta.title, href: `${base}/page/${page.meta.slug}/` },
  ]}
>
  <article class="page-content" data-eo-op="DES" data-eo-target={page.content_id}>
    <header class="content-header">
      <h1>{page.meta.title}</h1>
      <code class="eo-op">
        <span class="eo-sym">⊡</span>
        <span class="eo-name">DES</span>(<span class="eo-target">{page.content_id}</span>, <span class="eo-operand">{`{title: "${page.meta.title}"}`}</span>)
      </code>
    </header>

    <div class="blocks">
      {page.block_order.length > 0
        ? page.block_order.map((id: string) => {
            const block = blockMap.get(id);
            if (!block || block.deleted) return null;
            return (
              <div class="block-eo-wrap" data-eo-op="INS" data-eo-target={`${page.content_id}/block:${block.block_id}`}>
                <code class="eo-op">
                  <span class="eo-sym">△</span>
                  <span class="eo-name">INS</span>(<span class="eo-target">{page.content_id}/block:{block.block_id}</span>, <span class="eo-operand">{`{type: "${block.block_type}"}`}</span>)
                </code>
                <Fragment set:html={renderBlock(block, pageLike, base)} />
              </div>
            );
          })
        : <p class="empty-page">This page has no content yet.</p>
      }
    </div>

    <div class="content-actions eo-admin-only" hidden>
      <a class="btn btn-edit" href={`${base}/admin/#page/${page.meta.slug}`}>Edit in Admin</a>
    </div>
  </article>

  <script is:inline>
  (function() {
    try {
      if (window.self === window.top && localStorage.getItem('eo_xano_auth') === '1') {
        document.querySelectorAll('.eo-admin-only').forEach(function(el) {
          el.removeAttribute('hidden');
        });
      }
    } catch(e) {}
  })();
  </script>
</Base>
