---
import Base from '../layouts/Base.astro';
import { loadSiteIndex, loadContent } from '../lib/state';
import type { NavEntry, ProjectedWiki, ProjectedBlog, ProjectedExperiment, ProjectedPage } from '../lib/state';

const index = loadSiteIndex();
const base = import.meta.env.BASE_URL.replace(/\/$/, '');

// Pull only published+public nav entries
const wikiEntries  = index.nav.filter((e: NavEntry) => e.content_type === 'wiki');
const blogEntries  = index.nav.filter((e: NavEntry) => e.content_type === 'blog');
const expEntries   = index.nav.filter((e: NavEntry) => e.content_type === 'experiment');
const pageEntries  = index.nav.filter((e: NavEntry) => e.content_type === 'page');

// Load full content for excerpts (wiki + blog)
function wikiExcerpt(contentId: string): string {
  const content = loadContent(contentId) as ProjectedWiki | null;
  const text = content?.current_revision?.content ?? '';
  if (!text) return '';
  // Strip markdown syntax for plain excerpt
  const plain = text.replace(/^#+\s+/gm, '').replace(/[*_`]/g, '').replace(/\[([^\]]+)\]\([^)]+\)/g, '$1');
  return plain.slice(0, 140).trimEnd() + (plain.length > 140 ? 'â€¦' : '');
}

function blogExcerpt(contentId: string): string {
  const content = loadContent(contentId) as ProjectedBlog | null;
  const text = content?.current_revision?.content ?? '';
  if (!text) return '';
  const plain = text.replace(/^#+\s+/gm, '').replace(/[*_`]/g, '').replace(/\[([^\]]+)\]\([^)]+\)/g, '$1');
  return plain.slice(0, 140).trimEnd() + (plain.length > 140 ? 'â€¦' : '');
}

// Collect all tags for tag cloud
const allTags = Array.from(
  new Set(index.nav.flatMap((e: NavEntry) => e.tags))
).filter(Boolean).sort();

const totalArticles = wikiEntries.length + blogEntries.length + expEntries.length + pageEntries.length;
const hasContent = totalArticles > 0;
---
<Base title="Home" description="A minimal, universal framework for data transformation.">

  <!-- â”€â”€ Hero â”€â”€ -->
  <section class="home-hero">
    <div class="hero-badge">Emergent Ontology</div>
    <h1 class="hero-title">A framework for everything that changes</h1>
    <p class="hero-sub">
      Nine operators, infinite composability. A minimal, universal language for data transformation,
      knowledge curation, and structured thought.
    </p>
    {hasContent && (
      <p class="hero-stats">
        {totalArticles} {totalArticles === 1 ? 'article' : 'articles'}
        {wikiEntries.length > 0 && <> Â· {wikiEntries.length} wiki</>}
        {blogEntries.length > 0 && <> Â· {blogEntries.length} blog</>}
        {expEntries.length > 0 && <> Â· {expEntries.length} experiments</>}
      </p>
    )}
  </section>

  {!hasContent && (
    <section class="home-empty">
      <div class="empty-card">
        <div class="empty-icon">âŠ¡</div>
        <h2>Nothing published yet</h2>
        <p>Create and publish content in the admin editor to see it here.</p>
        <a class="btn btn-primary" href={`${base}/admin/`}>Open Admin Editor</a>
      </div>
    </section>
  )}

  {/* â”€â”€ Wiki section â”€â”€ */}
  {wikiEntries.length > 0 && (
    <section class="home-section">
      <div class="section-header">
        <h2 class="section-title">
          <span class="section-icon">ğŸ“–</span>
          Wiki
        </h2>
        <a class="section-viewall" href={`${base}/wiki/`}>All articles â†’</a>
      </div>
      <div class="content-grid">
        {wikiEntries.slice(0, 6).map((e: NavEntry) => {
          const excerpt = wikiExcerpt(e.content_id);
          return (
            <a class="content-card" href={`${base}/wiki/${e.slug}/`}>
              <div class="card-type">wiki</div>
              <h3 class="card-title">{e.title}</h3>
              {excerpt && <p class="card-excerpt">{excerpt}</p>}
              {e.tags.length > 0 && (
                <div class="card-tags">
                  {e.tags.slice(0, 3).map((t: string) => (
                    <span class="tag">{t}</span>
                  ))}
                </div>
              )}
            </a>
          );
        })}
      </div>
      {wikiEntries.length > 6 && (
        <div class="section-footer">
          <a class="btn btn-outline" href={`${base}/wiki/`}>
            View all {wikiEntries.length} articles
          </a>
        </div>
      )}
    </section>
  )}

  {/* â”€â”€ Blog section â”€â”€ */}
  {blogEntries.length > 0 && (
    <section class="home-section">
      <div class="section-header">
        <h2 class="section-title">
          <span class="section-icon">âœï¸</span>
          Blog
        </h2>
        <a class="section-viewall" href={`${base}/blog/`}>All posts â†’</a>
      </div>
      <div class="content-list-cards">
        {blogEntries.slice(0, 5).map((e: NavEntry) => {
          const excerpt = blogExcerpt(e.content_id);
          return (
            <a class="list-card" href={`${base}/blog/${e.slug}/`}>
              <div class="list-card-body">
                <div class="card-type">post</div>
                <h3 class="list-card-title">{e.title}</h3>
                {excerpt && <p class="card-excerpt">{excerpt}</p>}
              </div>
              <div class="list-card-arrow">â†’</div>
            </a>
          );
        })}
      </div>
    </section>
  )}

  {/* â”€â”€ Experiments section â”€â”€ */}
  {expEntries.length > 0 && (
    <section class="home-section">
      <div class="section-header">
        <h2 class="section-title">
          <span class="section-icon">ğŸ”¬</span>
          Experiments
        </h2>
        <a class="section-viewall" href={`${base}/exp/`}>All experiments â†’</a>
      </div>
      <div class="content-grid content-grid--sm">
        {expEntries.slice(0, 4).map((e: NavEntry) => (
          <a class="content-card content-card--exp" href={`${base}/exp/${e.slug}/`}>
            <div class="card-type">experiment</div>
            <h3 class="card-title">{e.title}</h3>
          </a>
        ))}
      </div>
    </section>
  )}

  {/* â”€â”€ Pages â”€â”€ */}
  {pageEntries.length > 0 && (
    <section class="home-section">
      <div class="section-header">
        <h2 class="section-title">
          <span class="section-icon">ğŸ“„</span>
          Pages
        </h2>
      </div>
      <ul class="content-list">
        {pageEntries.map((e: NavEntry) => (
          <li>
            <a href={`${base}/page/${e.slug}/`}>{e.title}</a>
          </li>
        ))}
      </ul>
    </section>
  )}

  {/* â”€â”€ Tags â”€â”€ */}
  {allTags.length > 0 && (
    <section class="home-section home-section--tags">
      <h2 class="section-title">
        <span class="section-icon">ğŸ·</span>
        Topics
      </h2>
      <div class="tag-cloud">
        {allTags.map((t: string) => (
          <span class="tag tag-lg">{t}</span>
        ))}
      </div>
    </section>
  )}

</Base>
