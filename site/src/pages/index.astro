---
import Base from '../layouts/Base.astro';
import { loadSiteIndex, loadContent } from '../lib/state';
import type { NavEntry, ProjectedWiki, ProjectedBlog, ProjectedPage } from '../lib/state';
import { renderBlock, escHtml } from '../lib/blocks';
import type { Block, PageLike } from '../lib/blocks';

const index = loadSiteIndex();
const base = import.meta.env.BASE_URL.replace(/\/$/, '');

// ‚îÄ‚îÄ Load editable homepage content (page:home) ‚îÄ‚îÄ
const homePage = loadContent('page:home') as ProjectedPage | null;
const hasHomeBlocks = homePage && homePage.block_order && homePage.block_order.length > 0;
const homeBlockMap = hasHomeBlocks
  ? new Map(homePage!.blocks.map((b: Block) => [b.block_id, b]))
  : new Map();
const homePageLike: PageLike = homePage ?? { content_id: 'page:home', blocks: [], block_order: [] };

// ‚îÄ‚îÄ Nav entries ‚îÄ‚îÄ
const wikiEntries  = index.nav.filter((e: NavEntry) => e.content_type === 'wiki');
const blogEntries  = index.nav.filter((e: NavEntry) => e.content_type === 'blog');
const expEntries   = index.nav.filter((e: NavEntry) => e.content_type === 'experiment');
const pageEntries  = index.nav.filter((e: NavEntry) => e.content_type === 'page');

function wikiExcerpt(contentId: string): string {
  const content = loadContent(contentId) as ProjectedWiki | null;
  const text = content?.current_revision?.content ?? '';
  if (!text) return '';
  const plain = text.replace(/^#+\s+/gm, '').replace(/[*_`]/g, '').replace(/\[([^\]]+)\]\([^)]+\)/g, '$1');
  return plain.slice(0, 140).trimEnd() + (plain.length > 140 ? '‚Ä¶' : '');
}

function blogExcerpt(contentId: string): string {
  const content = loadContent(contentId) as ProjectedBlog | null;
  const text = content?.current_revision?.content ?? '';
  if (!text) return '';
  const plain = text.replace(/^#+\s+/gm, '').replace(/[*_`]/g, '').replace(/\[([^\]]+)\]\([^)]+\)/g, '$1');
  return plain.slice(0, 140).trimEnd() + (plain.length > 140 ? '‚Ä¶' : '');
}

const allTags = Array.from(
  new Set(index.nav.flatMap((e: NavEntry) => e.tags))
).filter(Boolean).sort();

const totalArticles = wikiEntries.length + blogEntries.length + expEntries.length + pageEntries.length;
const hasContent = totalArticles > 0;

// Nine operators data
const operators = [
  { num: 1, symbol: '‚àÖ', code: 'NUL', greek: 'ŒΩ', label: 'Absence & Nullity', color: '#9ca3af', slug: 'nul' },
  { num: 2, symbol: '‚ä°', code: 'DES', greek: 'Œ¥', label: 'Designation', color: '#60a5fa', slug: 'des' },
  { num: 3, symbol: '‚ñ≥', code: 'INS', greek: 'Œπ', label: 'Instantiation', color: '#4ade80', slug: 'ins' },
  { num: 4, symbol: 'ÔΩú', code: 'SEG', greek: 'œÉ', label: 'Segmentation', color: '#c084fc', slug: 'seg' },
  { num: 5, symbol: '‚ãà', code: 'CON', greek: 'Œ∫', label: 'Connection', color: '#34d399', slug: 'con' },
  { num: 6, symbol: '‚àø', code: 'ALT', greek: 'Œ±', label: 'Alternation', color: '#fbbf24', slug: 'alt' },
  { num: 7, symbol: '‚à®', code: 'SYN', greek: 'œà', label: 'Synthesis', color: '#818cf8', slug: 'syn' },
  { num: 8, symbol: '‚à•', code: 'SUP', greek: 'œÜ', label: 'Superposition', color: '#f472b6', slug: 'sup' },
  { num: 9, symbol: '‚ü≥', code: 'REC', greek: 'œÅ', label: 'Recursion', color: '#fb923c', slug: 'rec' },
];
---
<Base title="Home" description="A minimal, universal framework for data transformation." mainClass="home">

  <!-- ‚îÄ‚îÄ Editable Homepage Content ‚îÄ‚îÄ -->
  {hasHomeBlocks ? (
    <section class="home-editable" data-eo-op="DES" data-eo-target="page:home">
      <div class="blocks">
        {homePage!.block_order.map((id: string) => {
          const block = homeBlockMap.get(id);
          if (!block || block.deleted) return null;
          return (
            <div class="block-eo-wrap" data-eo-op="INS" data-eo-target={`page:home/block:${block.block_id}`}>
              <Fragment set:html={renderBlock(block, homePageLike, base)} />
            </div>
          );
        })}
      </div>
      <div class="home-edit-link">
        <a class="btn btn-edit" href={`${base}/admin/#page/home`}>Edit Homepage</a>
      </div>
    </section>
  ) : (
    <section class="home-hero">
      <div class="hero-badge">Emergent Ontology</div>
      <h1 class="hero-title">A framework for everything that changes</h1>
      <p class="hero-sub">
        Nine operators, infinite composability. A minimal, universal language for data transformation,
        knowledge curation, and structured thought.
      </p>
      {hasContent && (
        <p class="hero-stats">
          {totalArticles} {totalArticles === 1 ? 'article' : 'articles'}
          {wikiEntries.length > 0 && <> ¬∑ {wikiEntries.length} wiki</>}
          {blogEntries.length > 0 && <> ¬∑ {blogEntries.length} blog</>}
          {expEntries.length > 0 && <> ¬∑ {expEntries.length} experiments</>}
        </p>
      )}
      <div class="home-edit-link" style="margin-top: 1.5rem;">
        <a class="btn btn-primary" href={`${base}/admin/#page/home`}>Set up Homepage</a>
      </div>
    </section>
  )}

  <!-- ‚îÄ‚îÄ Two-column layout: content left, rune grid right ‚îÄ‚îÄ -->
  <div class="home-columns">
    <div class="home-col-main">

  {!hasContent && !hasHomeBlocks && (
    <section class="home-empty">
      <div class="empty-card">
        <div class="empty-icon">‚ä°</div>
        <h2>Nothing published yet</h2>
        <p>Create and publish content in the admin editor to see it here.</p>
        <a class="btn btn-primary" href={`${base}/admin/`}>Open Admin Editor</a>
      </div>
    </section>
  )}

  {/* ‚îÄ‚îÄ Wiki section ‚îÄ‚îÄ */}
  {wikiEntries.length > 0 && (
    <section class="home-section">
      <div class="section-header">
        <h2 class="section-title">
          <span class="section-icon">üìñ</span>
          Wiki
        </h2>
        <a class="section-viewall" href={`${base}/wiki/`}>Wiki ‚Üí</a>
      </div>
      <div class="content-grid">
        {wikiEntries.slice(0, 6).map((e: NavEntry) => {
          const excerpt = wikiExcerpt(e.content_id);
          return (
            <a class="content-card" href={`${base}/wiki/${e.slug}/`}>
              <div class="card-type"><code class="eo-op"><span class="eo-name">DES</span>(<span class="eo-target">{e.content_id}</span>)</code></div>
              <h3 class="card-title">{e.title}</h3>
              {excerpt && <p class="card-excerpt">{excerpt}</p>}
              {e.tags.length > 0 && (
                <div class="card-tags">
                  {e.tags.slice(0, 3).map((t: string) => (
                    <span class="tag">{t}</span>
                  ))}
                </div>
              )}
            </a>
          );
        })}
      </div>
      {wikiEntries.length > 6 && (
        <div class="section-footer">
          <a class="btn btn-outline" href={`${base}/wiki/`}>
            View all wiki entries
          </a>
        </div>
      )}
    </section>
  )}

  {/* ‚îÄ‚îÄ Blog section ‚îÄ‚îÄ */}
  {blogEntries.length > 0 && (
    <section class="home-section">
      <div class="section-header">
        <h2 class="section-title">
          <span class="section-icon">‚úçÔ∏è</span>
          Blog
        </h2>
        <a class="section-viewall" href={`${base}/blog/`}>All posts ‚Üí</a>
      </div>
      <div class="content-list-cards">
        {blogEntries.slice(0, 5).map((e: NavEntry) => {
          const excerpt = blogExcerpt(e.content_id);
          return (
            <a class="list-card" href={`${base}/blog/${e.slug}/`}>
              <div class="list-card-body">
                <div class="card-type"><code class="eo-op"><span class="eo-name">DES</span>(<span class="eo-target">{e.content_id}</span>)</code></div>
                <h3 class="list-card-title">{e.title}</h3>
                {excerpt && <p class="card-excerpt">{excerpt}</p>}
              </div>
              <div class="list-card-arrow">‚Üí</div>
            </a>
          );
        })}
      </div>
    </section>
  )}

  {/* ‚îÄ‚îÄ Experiments section ‚îÄ‚îÄ */}
  {expEntries.length > 0 && (
    <section class="home-section">
      <div class="section-header">
        <h2 class="section-title">
          <span class="section-icon">üî¨</span>
          Experiments
        </h2>
        <a class="section-viewall" href={`${base}/exp/`}>All experiments ‚Üí</a>
      </div>
      <div class="content-grid content-grid--sm">
        {expEntries.slice(0, 4).map((e: NavEntry) => (
          <a class="content-card content-card--exp" href={`${base}/exp/${e.slug}/`}>
            <div class="card-type"><code class="eo-op"><span class="eo-name">DES</span>(<span class="eo-target">{e.content_id}</span>)</code></div>
            <h3 class="card-title">{e.title}</h3>
          </a>
        ))}
      </div>
    </section>
  )}

  {/* ‚îÄ‚îÄ Pages ‚îÄ‚îÄ */}
  {pageEntries.length > 0 && (
    <section class="home-section">
      <div class="section-header">
        <h2 class="section-title">
          <span class="section-icon">üìÑ</span>
          Pages
        </h2>
      </div>
      <ul class="content-list">
        {pageEntries.map((e: NavEntry) => (
          <li>
            <a href={`${base}/page/${e.slug}/`}>{e.title}</a>
            <code class="eo-op"><span class="eo-name">DES</span>(<span class="eo-target">{e.content_id}</span>)</code>
          </li>
        ))}
      </ul>
    </section>
  )}

  {/* ‚îÄ‚îÄ Tags ‚îÄ‚îÄ */}
  {allTags.length > 0 && (
    <section class="home-section home-section--tags">
      <h2 class="section-title">
        <span class="section-icon">üè∑</span>
        Topics
      </h2>
      <div class="tag-cloud">
        {allTags.map((t: string) => (
          <span class="tag tag-lg">{t}</span>
        ))}
      </div>
    </section>
  )}

    </div>{/* end .home-col-main */}

    <!-- ‚îÄ‚îÄ Rune Grid (right column) ‚îÄ‚îÄ -->
    <aside class="rune-grid-aside" aria-label="Nine Operators">
      <button class="rune-mode-toggle" id="rune-mode-toggle" aria-label="Toggle operator display mode" title="Toggle display: Runes / Greek / Code">
        <span class="rune-mode-label" id="rune-mode-label">Runes</span>
        <svg width="12" height="12" viewBox="0 0 12 12" fill="none" aria-hidden="true">
          <path d="M3 5l3 3 3-3" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>
      <div class="rune-grid" id="rune-grid" data-mode="runes">
        {operators.map((op) => (
          <a class="rune-cell" href={`${base}/wiki/${op.slug}/`} title={`${op.code} ‚Äî ${op.label}`} style={`--rune-color: ${op.color}`}>
            <span class="rune-sym rune-sym--rune">{op.symbol}</span>
            <span class="rune-sym rune-sym--greek">{op.greek}</span>
            <span class="rune-sym rune-sym--code">{op.code}</span>
            <span class="rune-code">{op.code}</span>
          </a>
        ))}
      </div>
    </aside>
  </div>{/* end .home-columns */}

  <script is:inline>
  (function() {
    var modes = ['runes', 'greek', 'code'];
    var labels = { runes: 'Runes', greek: 'Greek', code: 'Code' };
    var grid = document.getElementById('rune-grid');
    var btn = document.getElementById('rune-mode-toggle');
    var label = document.getElementById('rune-mode-label');
    if (!grid || !btn || !label) return;

    var saved = localStorage.getItem('eo-rune-mode');
    var idx = saved ? modes.indexOf(saved) : 0;
    if (idx < 0) idx = 0;
    grid.setAttribute('data-mode', modes[idx]);
    label.textContent = labels[modes[idx]];

    btn.addEventListener('click', function() {
      idx = (idx + 1) % modes.length;
      grid.setAttribute('data-mode', modes[idx]);
      label.textContent = labels[modes[idx]];
      localStorage.setItem('eo-rune-mode', modes[idx]);
    });
  })();
  </script>

</Base>
