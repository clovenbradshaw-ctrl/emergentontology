---
import Base from '../../layouts/Base.astro';
import { loadPublishedContent } from '../../lib/state';
import type { ProjectedBlog } from '../../lib/state';

export async function getStaticPaths() {
  const items = loadPublishedContent('blog') as ProjectedBlog[];
  const sorted = [...items].sort((a, b) => {
    const da = a.current_revision?.ts ?? a.meta.updated_at;
    const db = b.current_revision?.ts ?? b.meta.updated_at;
    return db.localeCompare(da); // newest first
  });
  return sorted.map((b, i) => ({
    params: { slug: b.meta.slug },
    props: {
      post: b,
      prevPost: sorted[i + 1] ?? null,
      nextPost: sorted[i - 1] ?? null,
    },
  }));
}

const { post, prevPost, nextPost } = Astro.props as {
  post: ProjectedBlog;
  prevPost: ProjectedBlog | null;
  nextPost: ProjectedBlog | null;
};
const base = import.meta.env.BASE_URL.replace(/\/$/, '');

function renderMarkdown(md: string): string {
  return md
    .replace(/^#{4}\s+(.+)$/gm, '<h4>$1</h4>')
    .replace(/^#{3}\s+(.+)$/gm, '<h3>$1</h3>')
    .replace(/^#{2}\s+(.+)$/gm, '<h2>$1</h2>')
    .replace(/^#{1}\s+(.+)$/gm, '<h1>$1</h1>')
    .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
    .replace(/\*(.+?)\*/g, '<em>$1</em>')
    .replace(/`(.+?)`/g, '<code>$1</code>')
    .replace(/\[(.+?)\]\((.+?)\)/g, '<a href="$2">$1</a>')
    .replace(/\n\n/g, '</p><p>')
    .replace(/^(?!<)(.+)/m, '<p>$1')
    .trimEnd() + '</p>';
}
---
<Base
  title={post.meta.title}
  breadcrumbs={[
    { label: 'Blog', href: `${base}/blog/` },
    { label: post.meta.title, href: `${base}/blog/${post.meta.slug}/` },
  ]}
>
  <article class="blog-content" data-eo-op="DES" data-eo-target={post.content_id}>
    <header class="content-header">
      <h1>{post.meta.title}</h1>
      <code class="eo-op">
        <span class="eo-sym">⊡</span>
        <span class="eo-name">DES</span>(<span class="eo-target">{post.content_id}</span>, <span class="eo-operand">{`{title: "${post.meta.title}"}`}</span>)
      </code>
      <div class="post-meta">
        {post.current_revision && (
          <time datetime={post.current_revision.ts}>
            {new Date(post.current_revision.ts).toLocaleDateString('en-US', {
              year: 'numeric', month: 'long', day: 'numeric'
            })}
          </time>
        )}
        <div class="content-tags">
          {post.meta.tags.map((t: string) => <span class="tag">{t}</span>)}
        </div>
      </div>
    </header>

    <div class="blog-body">
      {post.current_revision
        ? <Fragment set:html={renderMarkdown(post.current_revision.content)} />
        : <p class="empty-page">No content yet.</p>
      }
    </div>

    {(prevPost || nextPost) && (
      <nav class="post-nav" aria-label="Post navigation">
        <div class="post-nav-prev">
          {prevPost && (
            <a href={`${base}/blog/${prevPost.meta.slug}/`}>
              <span class="post-nav-label">← Older</span>
              <span class="post-nav-title">{prevPost.meta.title}</span>
            </a>
          )}
        </div>
        <div class="post-nav-next">
          {nextPost && (
            <a href={`${base}/blog/${nextPost.meta.slug}/`}>
              <span class="post-nav-label">Newer →</span>
              <span class="post-nav-title">{nextPost.meta.title}</span>
            </a>
          )}
        </div>
      </nav>
    )}

    <div class="content-actions eo-admin-only" hidden>
      <a class="btn btn-edit" href={`${base}/admin/#blog/${post.meta.slug}`}>Edit in Admin</a>
    </div>
  </article>

  <script is:inline>
  (function() {
    try {
      if (window.self === window.top && localStorage.getItem('eo_xano_auth') === '1') {
        document.querySelectorAll('.eo-admin-only').forEach(function(el) {
          el.removeAttribute('hidden');
        });
      }
    } catch(e) {}
  })();
  </script>
</Base>
