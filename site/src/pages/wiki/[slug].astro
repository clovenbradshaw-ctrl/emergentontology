---
import Base from '../../layouts/Base.astro';
import { loadAllContent, loadContent } from '../../lib/state';
import type { ProjectedWiki } from '../../lib/state';

// Nine operators — defined inside getStaticPaths because Astro hoists
// exported functions to module scope where frontmatter vars aren't available.
export async function getStaticPaths() {
  const operators = [
    { slug: 'nul', code: 'NUL', label: 'Absence & Nullity', symbol: '∅', color: '#9ca3af' },
    { slug: 'des', code: 'DES', label: 'Designation', symbol: '⊡', color: '#60a5fa' },
    { slug: 'ins', code: 'INS', label: 'Instantiation', symbol: '△', color: '#4ade80' },
    { slug: 'seg', code: 'SEG', label: 'Segmentation', symbol: '｜', color: '#c084fc' },
    { slug: 'con', code: 'CON', label: 'Connection', symbol: '⋈', color: '#34d399' },
    { slug: 'alt', code: 'ALT', label: 'Alternation', symbol: '∿', color: '#fbbf24' },
    { slug: 'syn', code: 'SYN', label: 'Synthesis', symbol: '∨', color: '#818cf8' },
    { slug: 'sup', code: 'SUP', label: 'Superposition', symbol: '∥', color: '#f472b6' },
    { slug: 'rec', code: 'REC', label: 'Recursion', symbol: '⟳', color: '#fb923c' },
  ];

  const items = loadAllContent('wiki') as ProjectedWiki[];

  // Content-backed wiki pages
  const contentPaths = items.map((w) => ({
    params: { slug: w.meta.slug },
    props: { wiki: w, operator: operators.find((o) => o.slug === w.meta.slug) || null },
  }));

  // Operator pages that don't already have content
  const existingSlugs = new Set(items.map((w) => w.meta.slug));
  const operatorPaths = operators
    .filter((o) => !existingSlugs.has(o.slug))
    .map((o) => ({
      params: { slug: o.slug },
      props: { wiki: null, operator: o },
    }));

  return [...contentPaths, ...operatorPaths];
}

const { wiki, operator } = Astro.props as {
  wiki: ProjectedWiki | null;
  operator: { slug: string; code: string; label: string; symbol: string; color: string } | null;
};

const title = wiki?.meta.title ?? (operator ? `${operator.code} — ${operator.label}` : 'Unknown');
const slug = wiki?.meta.slug ?? operator?.slug ?? '';
const base = import.meta.env.BASE_URL.replace(/\/$/, '');

function renderMarkdown(md: string): string {
  return md
    .replace(/^#{4}\s+(.+)$/gm, '<h4>$1</h4>')
    .replace(/^#{3}\s+(.+)$/gm, '<h3>$1</h3>')
    .replace(/^#{2}\s+(.+)$/gm, '<h2>$1</h2>')
    .replace(/^#{1}\s+(.+)$/gm, '<h1>$1</h1>')
    .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
    .replace(/\*(.+?)\*/g, '<em>$1</em>')
    .replace(/`(.+?)`/g, '<code>$1</code>')
    .replace(/\[(.+?)\]\((.+?)\)/g, '<a href="$2">$1</a>')
    .replace(/\n\n/g, '</p><p>')
    .replace(/^(?!<)(.+)/m, '<p>$1')
    .trimEnd() + '</p>';
}
---
<Base
  title={title}
  breadcrumbs={[
    { label: 'Home', href: `${base}/` },
    { label: 'Wiki', href: `${base}/wiki/` },
    { label: title, href: `${base}/wiki/${slug}/` },
  ]}
>
  {wiki ? (
    <article class="wiki-content" data-eo-op="DES" data-eo-target={wiki.content_id}>
      <header class="content-header">
        <h1>{wiki.meta.title}</h1>
        <code class="eo-op">
          <span class="eo-sym">⊡</span>
          <span class="eo-name">DES</span>(<span class="eo-target">{wiki.content_id}</span>, <span class="eo-operand">{`{title: "${wiki.meta.title}"}`}</span>)
        </code>
        <div class="content-tags">
          {wiki.meta.tags.map((t: string) => <span class="tag">{t}</span>)}
        </div>
      </header>

      {wiki.has_conflict && (
        <div class="conflict-banner">
          <strong>Conflict detected:</strong> There are {wiki.conflict_candidates.length} concurrent revisions.
          <a href="#history">View history</a> or resolve via admin.
        </div>
      )}

      <div class="wiki-body">
        {wiki.current_revision
          ? <Fragment set:html={renderMarkdown(wiki.current_revision.content)} />
          : <p class="empty-page">No content yet.</p>
        }
      </div>

      <section class="revision-history" id="history">
        <h2>Revision History</h2>
        {wiki.revisions.length > 0 ? (
          <>
            <ol class="rev-list" reversed>
              {wiki.revisions
                .slice()
                .reverse()
                .slice(0, 6)
                .map((r) => {
                  const isFirst = r.rev_id === wiki.revisions[0]?.rev_id;
                  const opName = isFirst ? 'INS' : 'ALT';
                  const opIcon = isFirst ? 'ph-plus-circle' : 'ph-pencil-simple';
                  return (
                    <li class={`rev-entry rev-entry--${opName.toLowerCase()}`} data-eo-op={opName} data-eo-target={`${wiki.content_id}/rev:${r.rev_id}`}>
                      <code class="eo-op eo-op-inline">
                        <i class={`ph ${opIcon} eo-ph-icon`}></i>
                        <span class="eo-name">{opName}</span>(<span class="eo-target">{wiki.content_id}/rev:{r.rev_id}</span>, <span class="eo-operand">{`{summary: "${r.summary || '…'}"}`}</span>)
                      </code>
                      <time class="rev-ts">{new Date(r.ts).toLocaleDateString()}</time>
                    </li>
                  );
                })}
            </ol>
            {wiki.revisions.length > 6 && (
              <details class="rev-overflow">
                <summary class="rev-expand-toggle">
                  Show {wiki.revisions.length - 6} older revision{wiki.revisions.length - 6 !== 1 ? 's' : ''}
                </summary>
                <ol class="rev-list rev-list-older">
                  {wiki.revisions
                    .slice()
                    .reverse()
                    .slice(6)
                    .map((r) => {
                      const isFirst = r.rev_id === wiki.revisions[0]?.rev_id;
                      const opName = isFirst ? 'INS' : 'ALT';
                      const opIcon = isFirst ? 'ph-plus-circle' : 'ph-pencil-simple';
                      return (
                        <li class={`rev-entry rev-entry--${opName.toLowerCase()}`} data-eo-op={opName} data-eo-target={`${wiki.content_id}/rev:${r.rev_id}`}>
                          <code class="eo-op eo-op-inline">
                            <i class={`ph ${opIcon} eo-ph-icon`}></i>
                            <span class="eo-name">{opName}</span>(<span class="eo-target">{wiki.content_id}/rev:{r.rev_id}</span>, <span class="eo-operand">{`{summary: "${r.summary || '…'}"}`}</span>)
                          </code>
                          <time class="rev-ts">{new Date(r.ts).toLocaleDateString()}</time>
                        </li>
                      );
                    })}
                </ol>
              </details>
            )}
          </>
        ) : (
          <ol class="rev-list"><li>No revisions yet.</li></ol>
        )}
      </section>

      <div class="content-actions">
        <a class="btn btn-edit" href={`${base}/admin/#wiki/${wiki.meta.slug}`}>Edit in Admin</a>
      </div>
    </article>
  ) : operator ? (
    <article class="wiki-content operator-page" data-eo-op={operator.code} data-eo-target={`wiki:${operator.slug}`}>
      <header class="content-header">
        <h1>
          <span class="operator-symbol" style={`color: ${operator.color}`}>{operator.symbol}</span>
          {operator.code} — {operator.label}
        </h1>
      </header>
      <div class="wiki-body">
      </div>
      <div class="content-actions">
        <a class="btn btn-edit" href={`${base}/admin/#wiki/${operator.slug}`}>Edit in Admin</a>
      </div>
    </article>
  ) : null}
</Base>
