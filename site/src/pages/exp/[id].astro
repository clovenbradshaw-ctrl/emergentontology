---
import Base from '../../layouts/Base.astro';
import { loadAllContent } from '../../lib/state';
import type { ProjectedExperiment, ExperimentEntry } from '../../lib/state';

export async function getStaticPaths() {
  const items = loadAllContent('experiment') as ProjectedExperiment[];
  return items.map((e) => ({
    params: { id: e.meta.slug },
    props: { exp: e },
  }));
}

const { exp } = Astro.props as { exp: ProjectedExperiment };
const base = import.meta.env.BASE_URL.replace(/\/$/, '');

const KIND_ICONS: Record<string, string> = {
  note: 'ğŸ“',
  dataset: 'ğŸ“Š',
  result: 'âœ…',
  chart: 'ğŸ“ˆ',
  link: 'ğŸ”—',
  decision: 'âš–ï¸',
};

function renderMarkdown(md: string): string {
  return md
    .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
    .replace(/\*(.+?)\*/g, '<em>$1</em>')
    .replace(/`(.+?)`/g, '<code>$1</code>')
    .replace(/\[(.+?)\]\((.+?)\)/g, '<a href="$2">$1</a>')
    .replace(/\n\n/g, '</p><p>')
    .replace(/^(?!<)(.+)/m, '<p>$1')
    .trimEnd() + '</p>';
}
---
<Base
  title={exp.meta.title}
  breadcrumbs={[
    { label: 'Home', href: `${base}/` },
    { label: 'Experiments', href: `${base}/exp/` },
    { label: exp.meta.title, href: `${base}/exp/${exp.meta.slug}/` },
  ]}
>
  <article class="exp-content">
    <header class="content-header">
      <h1>{exp.meta.title}</h1>
      <div class="content-tags">
        {exp.meta.tags.map((t: string) => <span class="tag">{t}</span>)}
      </div>
    </header>

    <ol class="exp-entries">
      {exp.entries.length > 0
        ? exp.entries.map((entry: ExperimentEntry) => (
            <li class={`exp-entry exp-entry-${entry.kind}`}>
              <span class="entry-kind" title={entry.kind}>
                {KIND_ICONS[entry.kind] ?? 'â€¢'}
              </span>
              <div class="entry-body">
                <Fragment set:html={renderMarkdown(String(entry.data.text ?? ''))} />
                {Array.isArray(entry.data.attachments) && entry.data.attachments.length > 0 && (
                  <ul class="attachments">
                    {(entry.data.attachments as string[]).map((a) => (
                      <li><a href={a}>{a}</a></li>
                    ))}
                  </ul>
                )}
              </div>
              <time class="entry-ts">{new Date(entry.ts).toLocaleDateString()}</time>
            </li>
          ))
        : <li class="empty-page">No entries yet.</li>
      }
    </ol>

    <div class="content-actions">
      <a class="btn btn-edit" href={`${base}/admin/#exp/${exp.meta.slug}`}>Add Entry in Admin</a>
    </div>
  </article>
</Base>
