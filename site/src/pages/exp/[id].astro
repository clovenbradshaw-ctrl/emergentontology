---
import Base from '../../layouts/Base.astro';
import { loadPublishedContent } from '../../lib/state';
import type { ProjectedExperiment, ExperimentEntry } from '../../lib/state';

export async function getStaticPaths() {
  const items = loadPublishedContent('experiment') as ProjectedExperiment[];
  return items.map((e) => ({
    params: { id: e.meta.slug },
    props: { exp: e },
  }));
}

const { exp } = Astro.props as { exp: ProjectedExperiment };
const base = import.meta.env.BASE_URL.replace(/\/$/, '');

const KIND_ICONS: Record<string, string> = {
  note: 'üìù',
  dataset: 'üìä',
  result: '‚úÖ',
  chart: 'üìà',
  link: 'üîó',
  decision: '‚öñÔ∏è',
};

function renderMarkdown(md: string): string {
  return md
    .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
    .replace(/\*(.+?)\*/g, '<em>$1</em>')
    .replace(/`(.+?)`/g, '<code>$1</code>')
    .replace(/\[(.+?)\]\((.+?)\)/g, '<a href="$2">$1</a>')
    .replace(/\n\n/g, '</p><p>')
    .replace(/^(?!<)(.+)/m, '<p>$1')
    .trimEnd() + '</p>';
}
---
<Base
  title={exp.meta.title}
  breadcrumbs={[
    { label: 'Home', href: `${base}/` },
    { label: 'Experiments', href: `${base}/exp/` },
    { label: exp.meta.title, href: `${base}/exp/${exp.meta.slug}/` },
  ]}
>
  <article class="exp-content" data-eo-op="DES" data-eo-target={exp.content_id}>
    <header class="content-header">
      <h1>{exp.meta.title}</h1>
      <code class="eo-op">
        <span class="eo-sym">‚ä°</span>
        <span class="eo-name">DES</span>(<span class="eo-target">{exp.content_id}</span>, <span class="eo-operand">{`{title: "${exp.meta.title}"}`}</span>)
      </code>
      <div class="content-tags">
        {exp.meta.tags.map((t: string) => <span class="tag">{t}</span>)}
      </div>
    </header>

    <ol class="exp-entries">
      {exp.entries.length > 0
        ? exp.entries.map((entry: ExperimentEntry) => (
            <li class={`exp-entry exp-entry-${entry.kind}`} data-eo-op="INS" data-eo-target={`${exp.content_id}/entry:${entry.entry_id}`}>
              <span class="entry-kind" title={entry.kind}>
                {KIND_ICONS[entry.kind] ?? '‚Ä¢'}
              </span>
              <div class="entry-body">
                <Fragment set:html={renderMarkdown(String(entry.data.text ?? ''))} />
                {Array.isArray(entry.data.attachments) && entry.data.attachments.length > 0 && (
                  <ul class="attachments">
                    {(entry.data.attachments as string[]).map((a) => (
                      <li><a href={a}>{a}</a></li>
                    ))}
                  </ul>
                )}
              </div>
              <div class="entry-eo-meta">
                <code class="eo-op eo-op-inline">
                  <span class="eo-sym">‚ñ≥</span>
                  <span class="eo-name">INS</span>(<span class="eo-target">{exp.content_id}/entry:{entry.entry_id}</span>, <span class="eo-operand">{`{kind: "${entry.kind}"}`}</span>)
                </code>
                <time class="entry-ts">{new Date(entry.ts).toLocaleDateString()}</time>
              </div>
            </li>
          ))
        : <li class="empty-page">No entries yet.</li>
      }
    </ol>

    <div class="content-actions eo-admin-only" hidden>
      <a class="btn btn-edit" href={`${base}/admin/#exp/${exp.meta.slug}`}>Add Entry in Admin</a>
    </div>
  </article>

  <script is:inline>
  (function() {
    try {
      if (localStorage.getItem('eo_xano_auth') === '1') {
        document.querySelectorAll('.eo-admin-only').forEach(function(el) {
          el.removeAttribute('hidden');
        });
      }
    } catch(e) {}
  })();
  </script>
</Base>
