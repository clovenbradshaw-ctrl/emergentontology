---
import { loadNav } from '../lib/state';
import type { NavEntry } from '../lib/state';

interface Props {
  title: string;
  description?: string;
  breadcrumbs?: Array<{ label: string; href: string }>;
  mainClass?: string;
}

const { title, description, breadcrumbs, mainClass } = Astro.props;
const nav = loadNav();

const base = import.meta.env.BASE_URL.replace(/\/$/, '');

const wikiNav  = nav.filter((e: NavEntry) => e.content_type === 'wiki');
const blogNav  = nav.filter((e: NavEntry) => e.content_type === 'blog');
const expNav   = nav.filter((e: NavEntry) => e.content_type === 'experiment');
// Pages: only show those with show_in_nav set (or default to showing all for backward compat)
const allPageNav = nav.filter((e: NavEntry) => e.content_type === 'page');
const pageNav  = allPageNav.some((e: NavEntry) => e.show_in_nav)
  ? allPageNav.filter((e: NavEntry) => e.show_in_nav)
  : allPageNav;
// Top-level pages (no parent) and children
const topPages = pageNav.filter((e: NavEntry) => !e.parent_page);
const childPages = (parentId: string) => pageNav.filter((e: NavEntry) => e.parent_page === parentId);
---
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>{title} — Emergent Ontology</title>
  {description && <meta name="description" content={description} />}
  <link rel="stylesheet" href={`${base}/styles/main.css`} />
  <link rel="alternate" type="application/json" href={`${base}/generated/state/index.json`} />
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>∅</text></svg>" />
  <script src="https://unpkg.com/@phosphor-icons/web@2.1.1" defer></script>
  <script is:inline>
    // Apply saved theme immediately to prevent flash of wrong theme
    (function() {
      var t = localStorage.getItem('eo-theme');
      if (!t) t = window.matchMedia('(prefers-color-scheme: light)').matches ? 'light' : 'dark';
      document.documentElement.setAttribute('data-theme', t);
    })();
  </script>
</head>
<body>
  <header class="site-header">
    <a class="site-logo" href={`${base}/`}>
      <span class="logo-mark">⊡</span>
      <span class="logo-text">Emergent Ontology</span>
    </a>

    <nav class="site-nav" aria-label="Main navigation">
      <ul class="nav-list">

        <!-- Wiki section -->
        <li class="nav-item has-dropdown">
          <a href={`${base}/wiki/`} class="nav-link">
            Wiki
            {wikiNav.length > 0 && <span class="nav-count">{wikiNav.length}</span>}
          </a>
          {wikiNav.length > 0 && (
            <ul class="nav-dropdown">
              {wikiNav.slice(0, 8).map((e: NavEntry) => (
                <li><a href={`${base}/wiki/${e.slug}/`}>{e.title}</a></li>
              ))}
              {wikiNav.length > 8 && (
                <li class="nav-more"><a href={`${base}/wiki/`}>More →</a></li>
              )}
            </ul>
          )}
        </li>

        <!-- Blog section -->
        <li class="nav-item has-dropdown">
          <a href={`${base}/blog/`} class="nav-link">
            Blog
            {blogNav.length > 0 && <span class="nav-count">{blogNav.length}</span>}
          </a>
          {blogNav.length > 0 && (
            <ul class="nav-dropdown">
              {blogNav.slice(0, 6).map((e: NavEntry) => (
                <li><a href={`${base}/blog/${e.slug}/`}>{e.title}</a></li>
              ))}
              {blogNav.length > 6 && (
                <li class="nav-more"><a href={`${base}/blog/`}>All posts →</a></li>
              )}
            </ul>
          )}
        </li>

        <!-- Experiments section -->
        {expNav.length > 0 && (
          <li class="nav-item">
            <a href={`${base}/exp/`} class="nav-link">
              Experiments
              <span class="nav-count">{expNav.length}</span>
            </a>
          </li>
        )}

        <!-- Standalone pages (with optional nesting) -->
        {topPages.map((e: NavEntry) => {
          const children = childPages(e.content_id);
          return children.length > 0 ? (
            <li class="nav-item has-dropdown">
              <a href={`${base}/page/${e.slug}/`} class="nav-link">{e.title}</a>
              <ul class="nav-dropdown">
                {children.map((c: NavEntry) => (
                  <li><a href={`${base}/page/${c.slug}/`}>{c.title}</a></li>
                ))}
              </ul>
            </li>
          ) : (
            <li class="nav-item">
              <a href={`${base}/page/${e.slug}/`} class="nav-link">{e.title}</a>
            </li>
          );
        })}

      </ul>
    </nav>

    <div class="header-actions">
      <button class="theme-toggle" id="theme-toggle" aria-label="Toggle light/dark mode" title="Toggle light/dark mode">
        <i class="ph ph-sun theme-icon-light" aria-hidden="true"></i>
        <i class="ph ph-moon theme-icon-dark" aria-hidden="true"></i>
      </button>
      <button class="search-toggle" id="search-toggle" aria-label="Search">
        <svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true">
          <circle cx="6.5" cy="6.5" r="5" stroke="currentColor" stroke-width="1.5"/>
          <path d="M10.5 10.5L14 14" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
        </svg>
      </button>
      <a class="admin-link" href={`${base}/admin/`}>Admin</a>
    </div>
  </header>

  <!-- Search overlay -->
  <div class="search-overlay" id="search-overlay" hidden>
    <div class="search-modal">
      <input
        id="search-input"
        type="search"
        placeholder="Search articles, posts, experiments…"
        aria-label="Search site"
        autocomplete="off"
        autofocus
      />
      <div id="search-results" class="search-results" role="list"></div>
      <button class="search-close" id="search-close" aria-label="Close search">Esc</button>
    </div>
  </div>

  <main class={mainClass}>
    {breadcrumbs && breadcrumbs.length > 0 && (
      <nav class="breadcrumbs" aria-label="Breadcrumb">
        <ol>
          <li><a href={`${base}/`}>Home</a></li>
          {breadcrumbs.map((crumb, i) =>
            i === breadcrumbs.length - 1
              ? <li aria-current="page">{crumb.label}</li>
              : <li><a href={crumb.href}>{crumb.label}</a></li>
          )}
        </ol>
      </nav>
    )}
    <slot />
  </main>

  <footer class="site-footer">
    <div class="footer-inner">
      <div class="footer-brand">
        <span class="logo-mark">⊡</span>
        <span>Emergent Ontology</span>
      </div>
      <nav class="footer-nav" aria-label="Footer navigation">
        <a href={`${base}/wiki/`}>Wiki</a>
        <a href={`${base}/blog/`}>Blog</a>
        {expNav.length > 0 && <a href={`${base}/exp/`}>Experiments</a>}
        <a href={`${base}/admin/`}>Admin</a>
        <a href={`${base}/generated/state/index.json`}>Site JSON</a>
      </nav>
    </div>
  </footer>

  <script src={`${base}/js/search.js`} defer></script>
  <script src={`${base}/js/xray.js`} defer></script>
  <script>
    // Wire search toggle
    const searchToggle = document.getElementById('search-toggle');
    const overlay = document.getElementById('search-overlay');
    const closeBtn = document.getElementById('search-close');
    const searchInput = document.getElementById('search-input');
    if (searchToggle && overlay) {
      searchToggle.addEventListener('click', () => { overlay.hidden = false; searchInput?.focus(); });
      closeBtn?.addEventListener('click', () => { overlay.hidden = true; });
      overlay.addEventListener('click', (e) => { if (e.target === overlay) overlay.hidden = true; });
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') overlay.hidden = true;
        if ((e.metaKey || e.ctrlKey) && e.key === 'k') { e.preventDefault(); overlay.hidden = false; searchInput?.focus(); }
      });
    }
    // Restyle xray button to use design system CSS class when it loads
    document.addEventListener('DOMContentLoaded', () => {
      const xrayBtn = document.getElementById('xray-toggle');
      if (xrayBtn) { xrayBtn.removeAttribute('style'); xrayBtn.classList.add('xray-fab'); }
    });

    // Theme toggle
    (function() {
      var btn = document.getElementById('theme-toggle');
      if (!btn) return;
      btn.addEventListener('click', function() {
        var current = document.documentElement.getAttribute('data-theme') || 'dark';
        var next = current === 'dark' ? 'light' : 'dark';
        document.documentElement.setAttribute('data-theme', next);
        localStorage.setItem('eo-theme', next);
      });
    })();
  </script>
</body>
</html>
