<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Emergent Ontology</title>
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>∅</text></svg>" />
  <script>
    (function() {
      var t = localStorage.getItem('eo-theme');
      if (!t) t = window.matchMedia('(prefers-color-scheme: light)').matches ? 'light' : 'dark';
      document.documentElement.setAttribute('data-theme', t);
    })();
  </script>
  <style>
    /* Design tokens */
    :root {
      --bg:       #0f0f0f;
      --bg2:      #1a1a1a;
      --bg3:      #222;
      --border:   #333;
      --text:     #e8e8e8;
      --text-dim: #888;
      --accent:   #7c6fcd;
      --link:     #9b8fd4;
      --shadow-color: rgba(0,0,0,.4);
      --font-sans: system-ui, -apple-system, 'Segoe UI', sans-serif;
      --font-mono: 'JetBrains Mono', 'Fira Code', monospace;
      --radius:   6px;
    }
    [data-theme="light"] {
      --bg:       #ffffff;
      --bg2:      #f5f5f7;
      --bg3:      #e8e8ec;
      --border:   #d1d1d6;
      --text:     #1d1d1f;
      --text-dim: #636366;
      --accent:   #5b4dba;
      --link:     #4a3fa0;
      --shadow-color: rgba(0,0,0,.12);
    }
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      background: var(--bg);
      color: var(--text);
      font-family: var(--font-sans);
      line-height: 1.6;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    a { color: var(--link); text-decoration: none; }
    a:hover { text-decoration: underline; }

    /* Header */
    .site-header {
      display: flex;
      align-items: center;
      gap: 2rem;
      padding: .75rem 2rem;
      background: var(--bg2);
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .site-logo { font-weight: 700; font-size: 1.1rem; color: var(--text); display: flex; align-items: center; gap: .45rem; }
    .site-logo:hover { text-decoration: none; color: var(--accent); }
    .logo-op {
      display: inline-block;
      font-size: 1.35rem;
      line-height: 1;
      width: 1.35rem;
      text-align: center;
      transition: opacity .45s ease, transform .45s ease, color .45s ease;
    }
    .logo-op.fade-out {
      opacity: 0;
      transform: scale(.6) rotate(-30deg);
    }
    .logo-op.fade-in {
      opacity: 1;
      transform: scale(1) rotate(0deg);
    }
    .site-nav ul { display: flex; gap: 1.5rem; list-style: none; }
    .site-nav a { color: var(--text-dim); font-size: .9rem; }
    .site-nav a:hover { color: var(--text); text-decoration: none; }
    .admin-link {
      margin-left: auto;
      background: var(--accent);
      color: #fff !important;
      padding: .35rem .85rem;
      border-radius: var(--radius);
      font-size: .85rem;
    }
    .admin-link:hover { background: var(--link); text-decoration: none; }
    .theme-toggle { background: none; border: 1px solid var(--border); border-radius: var(--radius); color: var(--text-dim); padding: .35rem .55rem; cursor: pointer; font-size: 1rem; line-height: 1; transition: border-color .15s, color .15s; }
    .theme-toggle:hover { border-color: var(--accent); color: var(--text); }
    .theme-icon-dark { display: none; }
    .theme-icon-light { display: inline; }
    [data-theme="light"] .theme-icon-dark { display: inline; }
    [data-theme="light"] .theme-icon-light { display: none; }

    /* Main */
    main { flex: 1; max-width: 860px; margin: 0 auto; padding: 2rem 1.5rem; width: 100%; }

    /* Hero */
    .hero { text-align: center; padding: 3rem 0 2rem; }
    .hero h1 { font-size: 2rem; font-weight: 700; }
    .hero-sub { color: var(--text-dim); margin-top: .5rem; font-size: 1.1rem; }
    .search-box { position: relative; max-width: 420px; margin: 1.5rem auto 0; }
    #search-input {
      width: 100%;
      background: var(--bg2);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: .65rem 1rem;
      color: var(--text);
      font-size: 1rem;
    }
    #search-input:focus { outline: none; border-color: var(--accent); }
    .search-results {
      position: absolute;
      top: calc(100% + 4px);
      left: 0; right: 0;
      background: var(--bg2);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      z-index: 50;
    }
    .search-result-item {
      display: block;
      padding: .6rem 1rem;
      border-bottom: 1px solid var(--border);
      color: var(--text);
    }
    .search-result-item:last-child { border-bottom: none; }
    .search-result-item:hover { background: var(--bg3); text-decoration: none; }

    /* Sections */
    .home-section { margin-top: 2.5rem; }
    .home-section h2 {
      margin-bottom: 1rem;
      border-bottom: 1px solid var(--border);
      padding-bottom: .5rem;
      font-size: 1.5rem;
      font-weight: 600;
    }
    .content-list { list-style: none; display: flex; flex-direction: column; gap: .75rem; }
    .content-list li { display: flex; align-items: baseline; gap: .75rem; flex-wrap: wrap; }
    .tags { display: flex; flex-wrap: wrap; gap: .35rem; }
    .tag {
      background: var(--bg3);
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: .15rem .6rem;
      font-size: .78rem;
      color: var(--text-dim);
    }
    .empty-note { color: var(--text-dim); font-style: italic; font-size: .95rem; }

    /* Template badge */
    .template-badge {
      display: inline-block;
      font-size: .7rem;
      background: var(--bg3);
      border: 1px dashed var(--border);
      color: var(--text-dim);
      border-radius: var(--radius);
      padding: .1rem .45rem;
      vertical-align: middle;
      margin-left: .4rem;
      font-family: var(--font-mono);
    }

    /* Delta banner */
    #delta-banner {
      display: none;
      position: fixed;
      bottom: 1.5rem;
      left: 50%;
      transform: translateX(-50%);
      background: var(--accent);
      color: #fff;
      padding: .55rem 1.25rem;
      border-radius: var(--radius);
      font-size: .9rem;
      cursor: pointer;
      z-index: 200;
      box-shadow: 0 4px 20px var(--shadow-color);
    }

    /* Footer */
    .site-footer {
      text-align: center;
      padding: 1.5rem;
      color: var(--text-dim);
      font-size: .8rem;
      border-top: 1px solid var(--border);
    }

    /* Ops grid */
    .ops-section { margin-top: 2.5rem; }
    .ops-section h2 {
      margin-bottom: 1rem;
      border-bottom: 1px solid var(--border);
      padding-bottom: .5rem;
      font-size: 1.5rem;
      font-weight: 600;
    }
    .ops-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 3px;
    }
    .ops-cell {
      position: relative;
      aspect-ratio: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: var(--bg2);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
      text-decoration: none;
      color: inherit;
    }
    .ops-cell:hover {
      background: var(--bg3);
      border-color: var(--accent);
      transform: scale(1.03);
      box-shadow: 0 0 24px var(--shadow-color);
    }
    .ops-symbol {
      font-size: clamp(2rem, 6vw, 3.5rem);
      line-height: 1;
      margin-bottom: 8px;
    }
    .ops-code {
      font-size: clamp(0.7rem, 1.8vw, 0.85rem);
      font-weight: 700;
      letter-spacing: 0.15em;
      text-transform: uppercase;
      color: var(--text-dim);
      margin-bottom: 4px;
      font-family: var(--font-mono);
    }
    .ops-label {
      font-size: clamp(0.55rem, 1.4vw, 0.72rem);
      color: var(--text-dim);
      text-align: center;
      line-height: 1.3;
    }
    .ops-num {
      position: absolute;
      top: 8px;
      left: 10px;
      font-size: 0.6rem;
      color: var(--border);
      font-weight: 600;
      font-family: var(--font-mono);
    }

    /* Responsive */
    @media (max-width: 640px) {
      .site-header { flex-wrap: wrap; }
      .site-nav ul { gap: 1rem; }
      main { padding: 1.25rem 1rem; }
      .hero h1 { font-size: 1.5rem; }
    }
  </style>
</head>
<body>

  <!-- ── Header ───────────────────────────────────────────────────────────── -->
  <header class="site-header">
    <a class="site-logo" href="./"><span class="logo-op fade-in" id="logo-op" aria-hidden="true">∅</span>Emergent Ontology</a>
    <nav class="site-nav" aria-label="Main navigation">
      <ul id="nav-list">
        <!-- Populated from Matrix state, empty until data loads -->
      </ul>
    </nav>
    <button class="theme-toggle" id="theme-toggle" aria-label="Toggle light/dark mode" title="Toggle light/dark mode">
      <span class="theme-icon-light" aria-hidden="true">&#9788;</span>
      <span class="theme-icon-dark" aria-hidden="true">&#9790;</span>
    </button>
    <a class="admin-link" href="admin/">Login</a>
  </header>

  <!-- ── Main ─────────────────────────────────────────────────────────────── -->
  <main>
    <!-- Hero -->
    <section class="hero">
      <h1>Emergent Ontology</h1>
      <p class="hero-sub">A minimal, universal framework for data transformation —<br>nine operators, infinite composability.</p>
      <div class="search-box">
        <input id="search-input" type="search" placeholder="Search…" aria-label="Search site" autocomplete="off" />
        <div id="search-results" class="search-results" role="list" hidden></div>
      </div>
    </section>

    <!-- Nine Operators reference grid -->
    <section class="ops-section" aria-label="Nine Operators">
      <h2>Nine Operators</h2>
      <div class="ops-grid">
        <a class="ops-cell" href="wiki/nul/"><span class="ops-num">1</span><div class="ops-symbol" style="color:#9ca3af">∅</div><div class="ops-code">NUL</div><div class="ops-label">Absence &amp; Nullity</div></a>
        <a class="ops-cell" href="wiki/des/"><span class="ops-num">2</span><div class="ops-symbol" style="color:#60a5fa">⊡</div><div class="ops-code">DES</div><div class="ops-label">Designation &amp; Definition</div></a>
        <a class="ops-cell" href="wiki/ins/"><span class="ops-num">3</span><div class="ops-symbol" style="color:#4ade80">△</div><div class="ops-code">INS</div><div class="ops-label">Instantiation</div></a>
        <a class="ops-cell" href="wiki/seg/"><span class="ops-num">4</span><div class="ops-symbol" style="color:#c084fc">｜</div><div class="ops-code">SEG</div><div class="ops-label">Segmentation</div></a>
        <a class="ops-cell" href="wiki/con/"><span class="ops-num">5</span><div class="ops-symbol" style="color:#34d399">⋈</div><div class="ops-code">CON</div><div class="ops-label">Connection</div></a>
        <a class="ops-cell" href="wiki/alt/"><span class="ops-num">6</span><div class="ops-symbol" style="color:#fbbf24">∿</div><div class="ops-code">ALT</div><div class="ops-label">Alternation</div></a>
        <a class="ops-cell" href="wiki/syn/"><span class="ops-num">7</span><div class="ops-symbol" style="color:#818cf8">∨</div><div class="ops-code">SYN</div><div class="ops-label">Synthesis</div></a>
        <a class="ops-cell" href="wiki/sup/"><span class="ops-num">8</span><div class="ops-symbol" style="color:#f472b6">∥</div><div class="ops-code">SUP</div><div class="ops-label">Superposition</div></a>
        <a class="ops-cell" href="wiki/rec/"><span class="ops-num">9</span><div class="ops-symbol" style="color:#fb923c">⟳</div><div class="ops-code">REC</div><div class="ops-label">Recursion</div></a>
      </div>
    </section>

    <!-- Wiki section -->
    <section class="home-section" id="section-wiki" data-type="wiki">
      <h2>Wiki</h2>
      <ul class="content-list" id="list-wiki">
        <li class="empty-note">No wiki entries published yet.</li>
      </ul>
    </section>

    <!-- Blog section -->
    <section class="home-section" id="section-blog" data-type="blog">
      <h2>Blog</h2>
      <ul class="content-list" id="list-blog">
        <li class="empty-note">No blog posts published yet.</li>
      </ul>
    </section>

    <!-- Experiments section -->
    <section class="home-section" id="section-experiment" data-type="experiment">
      <h2>Experiments</h2>
      <ul class="content-list" id="list-experiment">
        <li class="empty-note">No experiments published yet.</li>
      </ul>
    </section>

    <!-- Pages section (hidden until Matrix data has page-type content) -->
    <section class="home-section" id="section-page" data-type="page" style="display:none">
      <h2>Pages</h2>
      <ul class="content-list" id="list-page"></ul>
    </section>
  </main>

  <!-- Delta reload banner -->
  <div id="delta-banner" role="status">Content updated — click to reload</div>

  <!-- ── Footer ────────────────────────────────────────────────────────────── -->
  <footer class="site-footer">
    <p>
      Content stored as append-only events in Matrix.
      <a href="generated/state/index.json">Site index JSON</a>
    </p>
  </footer>

  <script>
    /**
     * Emergent Ontology — root index
     *
     * 1. Page renders immediately with hardcoded template content.
     * 2. We try to fetch /generated/state/index.json (written by the
     *    projector after every CI run).  If it exists we swap in the
     *    real published content and hide any sections that have none.
     * 3. We also try /js/live-sync.js for delta updates (present once
     *    the Astro build has deployed).
     */

    // ── helpers ──────────────────────────────────────────────────────────────

    function typeDir(type) {
      return type === 'page' ? 'page' : type === 'experiment' ? 'exp' : type;
    }

    function buildListItem(entry) {
      const li = document.createElement('li');
      const a  = document.createElement('a');
      const dir = typeDir(entry.content_type);
      a.href        = `${dir}/${entry.slug}/`;
      a.textContent = entry.title;
      li.appendChild(a);
      if (entry.tags && entry.tags.length) {
        const span = document.createElement('span');
        span.className = 'tags';
        entry.tags.forEach(t => {
          const tag = document.createElement('span');
          tag.className = 'tag';
          tag.textContent = t;
          span.appendChild(tag);
        });
        li.appendChild(span);
      }
      return li;
    }

    // ── apply a site-index snapshot to the DOM ────────────────────────────────

    function applyIndex(index) {
      const nav   = document.getElementById('nav-list');
      const types = ['wiki', 'blog', 'experiment', 'page'];

      // Rebuild nav from all published entries
      nav.innerHTML = '';
      (index.nav || []).forEach(entry => {
        const li = document.createElement('li');
        const a  = document.createElement('a');
        a.href        = `${typeDir(entry.content_type)}/${entry.slug}/`;
        a.textContent = entry.title;
        li.appendChild(a);
        nav.appendChild(li);
      });

      // Rebuild each content section
      types.forEach(type => {
        const section = document.getElementById('section-' + type);
        const list    = document.getElementById('list-' + type);
        if (!section || !list) return;

        const entries = (index.nav || []).filter(e => e.content_type === type);
        if (entries.length === 0) {
          // Keep section hidden if it was page, otherwise show empty note
          if (type === 'page') {
            section.style.display = 'none';
          } else {
            list.innerHTML = '<li class="empty-note">No ' + type + ' entries published yet.</li>';
            section.style.display = '';
          }
        } else {
          list.innerHTML = '';
          entries.forEach(e => list.appendChild(buildListItem(e)));
          section.style.display = '';
        }
      });
    }

    // ── bootstrap ────────────────────────────────────────────────────────────

    (async function boot() {
      // 1. Try to load the generated state snapshot
      try {
        const res = await fetch('generated/state/index.json', { cache: 'no-store' });
        if (res.ok) {
          const index = await res.json();
          applyIndex(index);
        }
      } catch (_) {
        // generated state not present yet — template content stays visible
      }

      // 2. Try to load the live-sync script (present after Astro build deploys)
      try {
        const probe = await fetch('js/live-sync.js', { method: 'HEAD' });
        if (probe.ok) {
          const s = document.createElement('script');
          s.src   = 'js/live-sync.js';
          s.defer = true;
          document.body.appendChild(s);
        }
      } catch (_) {}

      // 3. Wire up simple inline search against the generated search index
      const input   = document.getElementById('search-input');
      const results = document.getElementById('search-results');
      if (!input || !results) return;

      let searchIndex = null;
      input.addEventListener('focus', async () => {
        if (searchIndex) return;
        try {
          const r = await fetch('generated/search_index.json');
          if (r.ok) searchIndex = await r.json();
        } catch (_) {}
      });

      input.addEventListener('input', () => {
        const q = input.value.trim().toLowerCase();
        if (!q || !searchIndex) { results.hidden = true; return; }
        const hits = searchIndex.filter(e =>
          (e.title  || '').toLowerCase().includes(q) ||
          (e.body   || '').toLowerCase().includes(q) ||
          (e.tags   || []).some(t => t.toLowerCase().includes(q))
        ).slice(0, 8);
        results.innerHTML = '';
        if (!hits.length) { results.hidden = true; return; }
        hits.forEach(h => {
          const a = document.createElement('a');
          a.className   = 'search-result-item';
          a.href        = `${typeDir(h.content_type)}/${h.slug}/`;
          a.textContent = h.title;
          results.appendChild(a);
        });
        results.hidden = false;
      });

      document.addEventListener('click', e => {
        if (!input.contains(e.target) && !results.contains(e.target)) {
          results.hidden = true;
        }
      });
    })();

    // Theme toggle
    (function() {
      var btn = document.getElementById('theme-toggle');
      if (!btn) return;
      btn.addEventListener('click', function() {
        var current = document.documentElement.getAttribute('data-theme') || 'dark';
        var next = current === 'dark' ? 'light' : 'dark';
        document.documentElement.setAttribute('data-theme', next);
        localStorage.setItem('eo-theme', next);
      });
    })();

    // Cycle logo icon through the nine operators
    (function() {
      var operators = [
        { symbol: '\u2205', color: '#9ca3af' },  // ∅ NUL
        { symbol: '\u22A1', color: '#60a5fa' },  // ⊡ DES
        { symbol: '\u25B3', color: '#4ade80' },  // △ INS
        { symbol: '\uFF5C', color: '#c084fc' },  // ｜ SEG
        { symbol: '\u22C8', color: '#34d399' },  // ⋈ CON
        { symbol: '\u223F', color: '#fbbf24' },  // ∿ ALT
        { symbol: '\u2228', color: '#818cf8' },  // ∨ SYN
        { symbol: '\u2225', color: '#f472b6' },  // ∥ SUP
        { symbol: '\u27F3', color: '#fb923c' }   // ⟳ REC
      ];
      var el = document.getElementById('logo-op');
      if (!el) return;
      var idx = 0;
      el.textContent = operators[0].symbol;
      el.style.color = operators[0].color;

      setInterval(function() {
        // fade out
        el.classList.remove('fade-in');
        el.classList.add('fade-out');
        setTimeout(function() {
          idx = (idx + 1) % operators.length;
          el.textContent = operators[idx].symbol;
          el.style.color = operators[idx].color;
          // fade in
          el.classList.remove('fade-out');
          el.classList.add('fade-in');
        }, 450);
      }, 3000);
    })();
  </script>
</body>
</html>
